name: Daily Real Estate Data Collection

on:
  schedule:
    # 매월 1일 새벽 1시 (UTC). 한국시간 기준 오전 10시.
    # cron 형식: 분 시 일 월 요일
    - cron: '0 1 1 * *'
  
  # 수동 실행을 위한 워크플로우 디스패치
  workflow_dispatch:
    inputs:
      city:
        description: '수집할 도시 선택'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - seoul
          - busan
          - incheon

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create data directory
      run: mkdir -p collected_data logs
      
    - name: Collect real estate data
      env: {}
      run: |
        echo "=== 데이터 수집 시작 ==="
        echo "시작 시간: $(date)"
        
        # GitHub Actions용 데이터 수집 스크립트 실행
        python github_actions_collector.py
        
        echo "=== 데이터 수집 완료 ==="
        echo "완료 시간: $(date)"
        
    - name: Commit and push data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 데이터 파일들 추가
        git add collected_data/
        git add logs/
        
        # 변경사항이 있으면 커밋
        if git diff --staged --quiet; then
          echo "새로운 데이터가 없습니다."
        else
          git commit -m "feat: 자동 데이터 수집 - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi
        
    - name: Upload data as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: real-estate-data-$(date +%Y%m%d)
        path: |
          collected_data/
          logs/
        retention-days: 30
