name: Cloudtype Auto Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'crawlers/**'
      - 'services/**'
      - 'database/**'
      - 'auto_data_collector.py'
      - 'cloudtype.toml'
      - 'Dockerfile.cloudtype'
  
  pull_request:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'crawlers/**'
      - 'services/**'
      - 'database/**'
      - 'auto_data_collector.py'
      - 'cloudtype.toml'
      - 'Dockerfile.cloudtype'
  
  # μλ™ μ‹¤ν–‰μ„ μ„ν• μ›ν¬ν”λ΅μ° λ””μ¤ν¨μΉ
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'κ°•μ  λ°°ν¬ (λ¨λ“  νμΌ λ³€κ²½μ‚¬ν•­ λ¬΄μ‹)'
        required: false
        default: false
        type: boolean

jobs:
  deploy-to-cloudtype:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate configuration files
      run: |
        echo "=== μ„¤μ • νμΌ κ²€μ¦ μ‹μ‘ ==="
        
        # cloudtype.toml νμΌ μ΅΄μ¬ ν™•μΈ
        if [ ! -f "cloudtype.toml" ]; then
          echo "β cloudtype.toml νμΌμ΄ μ—†μµλ‹λ‹¤!"
          exit 1
        fi
        
        # Dockerfile.cloudtype νμΌ μ΅΄μ¬ ν™•μΈ
        if [ ! -f "Dockerfile.cloudtype" ]; then
          echo "β Dockerfile.cloudtype νμΌμ΄ μ—†μµλ‹λ‹¤!"
          exit 1
        fi
        
        # app.py νμΌ μ΅΄μ¬ ν™•μΈ
        if [ ! -f "app.py" ]; then
          echo "β app.py νμΌμ΄ μ—†μµλ‹λ‹¤!"
          exit 1
        fi
        
        # requirements.txt νμΌ μ΅΄μ¬ ν™•μΈ
        if [ ! -f "requirements.txt" ]; then
          echo "β requirements.txt νμΌμ΄ μ—†μµλ‹λ‹¤!"
          exit 1
        fi
        
        echo "β… λ¨λ“  ν•„μ νμΌμ΄ μ΅΄μ¬ν•©λ‹λ‹¤"
        
        # cloudtype.toml λ‚΄μ© κ²€μ¦
        echo "=== cloudtype.toml λ‚΄μ© ν™•μΈ ==="
        cat cloudtype.toml
        
        echo "=== Dockerfile.cloudtype λ‚΄μ© ν™•μΈ ==="
        cat Dockerfile.cloudtype
        
    - name: Test application startup
      run: |
        echo "=== μ• ν”λ¦¬μΌ€μ΄μ… μ‹μ‘ ν…μ¤νΈ ==="
        
        # ν™κ²½ λ³€μ μ„¤μ •
        export FLASK_APP=app.py
        export FLASK_ENV=production
        export PORT=5002
        
        # κ°„λ‹¨ν• μ‹μ‘ ν…μ¤νΈ (μ‹¤μ  μ„λ²„ μ‹μ‘μ€ ν•μ§€ μ•μ)
        python -c "
import app
print('β… Flask μ• ν”λ¦¬μΌ€μ΄μ… μ„ν¬νΈ μ„±κ³µ')
print(f'β… μ•± μ΄λ¦„: {app.__name__}')
print('β… μ• ν”λ¦¬μΌ€μ΄μ… μ‹μ‘ ν…μ¤νΈ μ™„λ£')
        "
        
    - name: Check for breaking changes
      run: |
        echo "=== νΈν™μ„± κ²€μ‚¬ μ‹μ‘ ==="
        
        # Python λ¬Έλ²• κ²€μ‚¬
        python -m py_compile app.py
        python -m py_compile auto_data_collector.py
        
        # μ£Όμ” λ¨λ“ μ„ν¬νΈ ν…μ¤νΈ
        python -c "
try:
    from crawlers.molit_api_crawler import MolitAPICrawler
    from crawlers.reb_api_crawler import REBAPICrawler
    from services.region_service import RegionService
    print('β… λ¨λ“  μ£Όμ” λ¨λ“ μ„ν¬νΈ μ„±κ³µ')
except ImportError as e:
    print(f'β λ¨λ“ μ„ν¬νΈ μ‹¤ν¨: {e}')
    exit(1)
        "
        
        echo "β… νΈν™μ„± κ²€μ‚¬ μ™„λ£"
        
    - name: Deploy to Cloudtype
      run: |
        echo "=== ν΄λΌμ°λ“νƒ€μ… λ°°ν¬ μ‹μ‘ ==="
        echo "λ°°ν¬ μ‹κ°„: $(date)"
        echo "μ»¤λ°‹ ν•΄μ‹: ${{ github.sha }}"
        echo "λΈλμΉ: ${{ github.ref_name }}"
        
        # ν΄λΌμ°λ“νƒ€μ… CLIκ°€ μλ‹¤λ©΄ μ—¬κΈ°μ„ λ°°ν¬ λ…λ Ή μ‹¤ν–‰
        # ν„μ¬λ” μλ™ λ°°ν¬λ¥Ό μ„ν• μ¤€λΉ„ λ‹¨κ³„
        
        echo "β… λ°°ν¬ μ¤€λΉ„ μ™„λ£"
        echo "π“ ν΄λΌμ°λ“νƒ€μ… λ€μ‹λ³΄λ“μ—μ„ μλ™μΌλ΅ Deploy λ²„νΌμ„ ν΄λ¦­ν•μ„Έμ”"
        echo "π”— https://cloudtype.io/projects/[ν”„λ΅μ νΈID]"
        
    - name: Create deployment summary
      run: |
        echo "=== λ°°ν¬ μ”μ•½ μƒμ„± ==="
        
        # λ³€κ²½λ νμΌ λ©λ΅
        echo "π“ λ³€κ²½λ νμΌ:"
        git diff --name-only HEAD~1 || echo "μ²« λ²μ§Έ μ»¤λ°‹μ΄λ―€λ΅ λ³€κ²½μ‚¬ν•­ μ—†μ"
        
        # λ°°ν¬ μ”μ•½ νμΌ μƒμ„±
        cat > deployment_summary.md << 'SUMMARY_EOF'
# π€ ν΄λΌμ°λ“νƒ€μ… λ°°ν¬ μ”μ•½

## π“… λ°°ν¬ μ‹κ°„
$(date)

## π”— μ»¤λ°‹ μ •λ³΄
- **μ»¤λ°‹ ν•΄μ‹**: ${{ github.sha }}
- **λΈλμΉ**: ${{ github.ref_name }}
- **μ‘μ„±μ**: ${{ github.actor }}

## π“ μ£Όμ” λ³€κ²½μ‚¬ν•­
$(git diff --name-only HEAD~1 2>/dev/null || echo "μ²« λ²μ§Έ μ»¤λ°‹")

## β… κ²€μ¦ κ²°κ³Ό
- μ„¤μ • νμΌ κ²€μ¦: β… μ™„λ£
- μ• ν”λ¦¬μΌ€μ΄μ… μ‹μ‘ ν…μ¤νΈ: β… μ™„λ£
- νΈν™μ„± κ²€μ‚¬: β… μ™„λ£
- λ°°ν¬ μ¤€λΉ„: β… μ™„λ£

## π― λ‹¤μ λ‹¨κ³„
ν΄λΌμ°λ“νƒ€μ… λ€μ‹λ³΄λ“μ—μ„ **Deploy** λ²„νΌμ„ ν΄λ¦­ν•μ—¬ μ‹¤μ  λ°°ν¬λ¥Ό μ§„ν–‰ν•μ„Έμ”.

## π“ μλ™ν™” μ •λ³΄
- **Cron μ‘μ—…**: λ§¤μ›” 1μΌ μƒλ²½ 1μ‹ μλ™ λ°μ΄ν„° μμ§‘
- **μλ™ λ°°ν¬**: GitHub push μ‹ μλ™ κ²€μ¦ λ° λ°°ν¬ μ¤€λΉ„
- **ν™κ²½**: Python 3.11, Flask, SQLite

---
*μ΄ μ”μ•½μ€ GitHub Actionsμ—μ„ μλ™μΌλ΅ μƒμ„±λμ—μµλ‹λ‹¤.*
SUMMARY_EOF
        
        echo "π“„ λ°°ν¬ μ”μ•½ νμΌ μƒμ„± μ™„λ£: deployment_summary.md"
        
    - name: Upload deployment summary
      uses: actions/upload-artifact@v4
      with:
        name: deployment-summary-$(date +%Y%m%d-%H%M%S)
        path: deployment_summary.md
        retention-days: 30
        
    - name: Notify deployment ready
      run: |
        echo "π‰ ν΄λΌμ°λ“νƒ€μ… λ°°ν¬ μ¤€λΉ„ μ™„λ£!"
        echo ""
        echo "π“‹ λ‹¤μ λ‹¨κ³„:"
        echo "1. ν΄λΌμ°λ“νƒ€μ… λ€μ‹λ³΄λ“ μ ‘μ†"
        echo "2. real-estate ν”„λ΅μ νΈ μ„ νƒ"
        echo "3. Deploy λ²„νΌ ν΄λ¦­"
        echo "4. λ°°ν¬ μ™„λ£ λ€κΈ°"
        echo ""
        echo "π”— ν΄λΌμ°λ“νƒ€μ…: https://cloudtype.io"
        echo "π“ ν”„λ΅μ νΈ: real-estate"
        
        # GitHub Actionsμ—μ„ λ³΄κΈ° μΆ‹κ² μ¶λ ¥
        echo "::notice::π€ ν΄λΌμ°λ“νƒ€μ… λ°°ν¬ μ¤€λΉ„ μ™„λ£! λ€μ‹λ³΄λ“μ—μ„ Deploy λ²„νΌμ„ ν΄λ¦­ν•μ„Έμ”."
