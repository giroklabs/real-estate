name: Cloudtype Auto Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-to-cloudtype:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate configuration files
      run: |
        echo "=== ì„¤ì • íŒŒì¼ ê²€ì¦ ì‹œì‘ ==="
        
        if [ ! -f "cloudtype.toml" ]; then
          echo "âŒ cloudtype.toml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        if [ ! -f "Dockerfile.cloudtype" ]; then
          echo "âŒ Dockerfile.cloudtype íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        if [ ! -f "app.py" ]; then
          echo "âŒ app.py íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… ëª¨ë“  í•„ìˆ˜ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤"
        
    - name: Test application startup
      run: |
        echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ í…ŒìŠ¤íŠ¸ ==="
        export FLASK_APP=app.py
        python -c "import app; print('âœ… Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ì„í¬íŠ¸ ì„±ê³µ')"
        
    - name: Deploy to Cloudtype
      run: |
        echo "=== í´ë¼ìš°ë“œíƒ€ì… ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ==="
        echo "ë°°í¬ ì‹œê°„: $(date)"
        echo "ì»¤ë°‹ í•´ì‹œ: ${{ github.sha }}"
        echo "ğŸ“ í´ë¼ìš°ë“œíƒ€ì… ëŒ€ì‹œë³´ë“œì—ì„œ Deploy ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”"
        
    - name: Notify deployment ready
      run: |
        echo "ğŸ‰ í´ë¼ìš°ë“œíƒ€ì… ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!"
        echo "ë‹¤ìŒ ë‹¨ê³„: í´ë¼ìš°ë“œíƒ€ì… ëŒ€ì‹œë³´ë“œì—ì„œ Deploy ë²„íŠ¼ í´ë¦­"
